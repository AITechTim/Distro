apiVersion: v1
kind: List
items:
 - apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: pathdb
     labels:
       service: pathdb
   spec:
     selector:
       matchLabels:
         service: pathdb
     template:
       metadata:
         labels:
           service: pathdb
       spec:
         hostAliases:
         - ip: "127.0.0.1"
           hostnames:
           - "quip-pathdb"
           - "quip-imageloader"
           - "quip-segloader"
           - "quip-hmloader"
           - "ca-iip"
           - "ca-mongo"
           - "ca-back"
         volumes:
           - name: images
             emptyDir: {}
           - name: data
             emptyDir: {}
           - name: jwtkeys
             secret:
               secretName: camic-jwt-keys
           - name: loginpage
             configMap:
               name: camic-login
           - name: pathdb-config
             configMap:
               name: pathdb-config
           - name: pathdb-pre
             configMap:
               name: pathdb-pre
         containers:
           - name: mongo
             image: mongo:4.2-bionic
             ports:
               - containerPort: 27017
           - name: back
             image: ghcr.io/camicroscope/caracal:master
             ports:
               - containerPort: 4010
             volumeMounts:
             - name: jwtkeys
               mountPath: /src/keys/
             - name: loginpage
               mountPath: /src/static/
             env:
               - name: PORT
                 value: "4010"
               - name: JWK_URL
                 value: "https://www.googleapis.com/oauth2/v3/certs"
               - name: IIP_PATH
                 value: "http://localhost:8080/fcgi-bin/iipsrv.fcgi"
               - name: MONGO_URI
                 value: "mongodb://localhost"
               - name: GENERATE_KEY_IF_MISSING
                 value: "true"
               - name: "DEFAULT_USER_TYPE"
                 value: "Editor"
               - name: "DISABLE_SEC"
                 value: "true"
               - name: "DISABLE_CSP"
                 value: "true"
           - name: iip
             image: camicroscope/iipimage:latest
             ports:
               - containerPort: 8080
             volumeMounts:
             - name: images
               mountPath: /images/
           - name: imageloader
             image: camicroscope/pathdb-imageloader:latest
             volumeMounts:
             - name: data
               mountPath: /data/
             - name: images
               mountPath: /data/images/
           - name: segloader
             image: camicroscope/pathdb-segloader:latest
             volumeMounts:
             - name: data
               mountPath: /data/
           - name: heatmaploader
             image: camicroscope/pathdb-heatmaploader:latest
             volumeMounts:
             - name: data
               mountPath: /mnt/data/
             env:
               - name: "TZ"
                 value: "America/New_York"
               - name: "DEBIAN_FRONTEND"
                 value: "noninteractive"
           - name: pathdb
             args:
                - /config/pathdb_pre.sh
             image: camicroscope/pathdb:latest
             ports:
               - containerPort: 443
               - containerPort: 80
             volumeMounts:
             - name: data
               mountPath: /data/
             - name: images
               mountPath: /data/pathdb/files/wsi
             - name: pathdb-pre
               mountPath: /config/pathdb_pre.sh
             - name: pathdb-config
               mountPath: /quip/web/sites/default
             - name: jwtkeys
               mountPath: /keys/
 - apiVersion: v1
   kind: Service
   metadata:
     name: pathdb
     labels:
       service: pathdb
   spec:
     type: NodePort
     selector:
       service: pathdb
     ports:
       - name: "443"
         port: 443
         targetPort: 443
         nodePort: 30443
       - name: "80"
         port: 80
         targetPort: 80
         nodePort: 30180
     type: LoadBalancer
